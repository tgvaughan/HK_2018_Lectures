---
title: Bayesian Phylodynamics
layout: presentation
reveal:
    theme: theme.css
---

<section class="titlepage center">

  <div class="title">
    Bayesian Phylodynamics
  </div>

  <div class="authors">
    Tim Vaughan
  </div>
  
  <div class="institution">
    ETH ZÃ¼rich
  </div>

  <div class="date">
    C3BI Course: Introduction to Molecular Phylogenetics<br>
    Hong Kong 2018
  </div>

</section>

<section>
  <h1>From tree priors...</h1>

  <ul>
    <li>In the first lecture on Bayesian phylogenetics, we briefly mentioned the role of tree-generating models.</li>
  </ul>

  <img data-src="Data_generation.svg" style="width:80%;text-align:center">

  <div class="flipper" style="height:300px;margin-top:50px">
    <img data-src="Posterior_treeprior_nohl.svg" class="fragment">
    <img data-src="Posterior_treeprior.svg" class="fragment">
  </div>
</section>

<section>
<h1>... to Phylodynamics</h1>

<dl class="spaced" style="margin-top:100px">
  <dt>Phylodynamics:</dt>
  <dd>the study of how ecological and evolutionary processes act/interact to shape the evolutionary history of pathogens (Grenfell et al., 2004; Volz et al., 2014).</dd>

  <dt data-spacing="1em">Phylodynamic inference:</dt>
  <dd>the statistical practice of inferring ecological/evolutionary dynamics from phylodynamic trees.</dd>
</dl>
  
</section>

<section>
  <h1>Example: An emerging epidemic</h1>

  <ul class="spaced" style="margin-top:100px;">
    <li>Consider a newly-emerging viral epidemic.</li>

    <li>Assume we have sequence data from which we can reconstruct a
      dated phylogenetic tree.</li>

    <li>We are interested in estimating epidemic dynamics and important
      epidemiological parameters like the epidemic growth rate.</li>
  </ul>
</section>

<section class="center">
  <div class="flipper" style="margin-top:100px">
    <img data-src="example_epidemic1.svg">
    <img data-src="example_epidemic2.svg" class="fragment">
    <img data-src="example_epidemic3.svg" class="fragment">
    <img data-src="example_epidemic4.svg" class="fragment">
    <img data-src="example_epidemic5.svg" class="fragment">
  </div>

</section>

<section>
  <h1>The need for phylodynamic models</h1>

  <ul class="spaced" style="margin-top:10%">
    <li class="fragment">Phylogenies only contain the ancestry of the
    individuals we sample.</li>

    <li class="fragment" style="margin-top:10%">We therefore need a
    statistical model that will allow us to infer the
      most probable epidemic dynamics and parameters given an incomplete phylogeny.</li>
  </ul>
</section>

<section>
  <h1>Classes of phylodynamic models</h1>

  <ul>
    <li class="fragment">Coalescent models
      <ul>
        <li class="fragment">Originally developed by John Kigman in a series of papers in 1982.</li>
        <li class="fragment">Extensions for dynamics and structured populations introduced by several authors.</li>
      </ul>
    </li>

    <li class="fragment" style="margin-top:5%">Birth-death models
      <ul>
        <li class="fragment">Theory for
        completely sampled contemporaneous trees developed by
        Elizabeth Thompson in her 1975 book "Human Evolutionary
        Trees".</li>
        <li class="fragment">Theory for trees conditioned on number of samples and extensions to incomplete sampling, sampling through time, structured populations, etc. developed by Tanja Stadler from 2008.</li>
      </ul>
    </li>
  </ul>
</section>

<section class="center">

  <img data-src="sampled_tree.svg" style="width:100%">

</section>

<section class="center">

  <h1>Questions?</h1>

</section>

<section class="center">
  <h1>Coalescent Theory</h1>
</section>

<section>
  <h1>The Wright-Fisher Model</h1>

  <div class="flipper" style="height:600px">
    <img data-src="WF1.svg" class="fragment">
    <img data-src="WF2.svg" class="fragment">
    <img data-src="WF3.svg" class="fragment">
    <img data-src="WF4.svg" class="fragment">
    <img data-src="WF5.svg" class="fragment">
    <img data-src="WF6.svg" class="fragment">
  </div>

  <!-- assumptions -->
</section>

<section>
  <h1>Wright-Fisher Model Assumptions</h1>

  <img data-src="WF6.svg" style="width:50%">

  <ul>
    <li>Discrete generations.</li>
    <li>Individuals identical. (No structure.)</li>
    <li>Fixed offspring distribution (mean of 1)</li>
    <li>Constant + finite population size.</li>
    <li>An interpretation: population at equilibrium (carrying capacity).</li>
  </ul>

</section>

<section>
  <h1>Sampled WF phylogeny</h1>

  <div class="flipper">
    <img data-src="WFsamp1.svg">
    <img data-src="WFsamp2.svg" class="fragment">
    <img data-src="WFsamp3.svg" class="fragment">
    <img data-src="WFsamp4.svg" class="fragment">
    <img data-src="WFsamp5.svg" class="fragment">
    <img data-src="WFsamp6.svg" class="fragment">
    <img data-src="WFsamp7.svg" class="fragment">
  </div>
</section>

<section>
  <h1>Sampled WF phylogeny</h1>

    <img data-src="WFsamp7.svg" style="width:70%">

    <ul>
      <li>Generations between internal nodes related to population size.</li>
      <li class="fragment">Can we quantify this relationship?</li>
    </ul>
</section>

<section>
  <h1>Sampled 2-individual phylogeny</h1>

  <div class="flipper" style="height:400px">
    <img data-src="WF2sampCoal1.svg">
    <img data-src="WF2sampCoal2.svg" class="fragment">
    <img data-src="WF2sampCoal3.svg" class="fragment">
    <img data-src="WF2sampCoal4.svg" class="fragment">
    <img data-src="WF2sampCoal5.svg" class="fragment">
    <img data-src="WF2sampCoal6.svg" class="fragment">
    <img data-src="WF2sampCoal7.svg" class="fragment">
    <img data-src="WF2sampCoal8.svg" class="fragment">
    <img data-src="WF2sampCoal9.svg" class="fragment">
    <img data-src="WF2sampCoal10.svg" class="fragment">
    <img data-src="WF2sampCoal11.svg" class="fragment">
  </div>
  
  <p class="fragment">
    Probability of coalescence in generation $i-m$:
    $P(m)=(1-p_{\textrm{coal}})^{m-1}p_{\textrm{coal}}$
  </p>

  <p class="fragment">
    Continuous time limit (large $N$, small $g$): $P(t)=e^{-\frac{1}{Ng}t}\frac{1}{Ng}$
  </p>

  <!-- properties: geometric distribution -->
</section>

<section>
  <h1>The exponential distribution</h1>


  <div id="expDistPlot" style="width:1000px;height:500px">
    <script>
      target = document.getElementById('expDistPlot');

      var tarr = [];
      var p1 = [];
      var p2 = [];
      var p3 = [];
      var tmax = 3.0;
      for (var t=0; t<=tmax; t+= tmax/500) {
          tarr.push(t);
          p3.push(Math.exp(-2*t)*2);
          p1.push(Math.exp(-t));
          p2.push(Math.exp(-0.5*t)*0.5);
      }

      var trace1 = {x: tarr, y: p1, name: 'Ng=0.5', line: {width: 4}};
      var trace2 = {x: tarr, y: p2, name: 'Ng=1', line: {width: 4}};
      var trace3 = {x: tarr, y: p3, name: 'Ng=2', line: {width: 4}};

      Plotly.plot(target,
                  [trace1, trace2, trace3],
                  { 
                      margin: { t: 0 },
                      xaxis: {title: "Time before present"},
                      yaxis: {title: "Probability density"},
                      font: {size: 20}
                  },
                  {displayModeBar: false});
    </script>
  </div>
</section>

<section>

  <h1>Sampled k-individual phylogeny</h1>
  <div class="flipper" style="height:400px">
    <img data-src="WF3sampCoal1.svg">
    <img data-src="WF3sampCoal2.svg" class="fragment">
    <img data-src="WF3sampCoal3.svg" class="fragment">
    <img data-src="WF3sampCoal4.svg" class="fragment">
  </div>

  <p class="fragment">
    <b>Question:</b> How can this be generalized to $k$ samples?
  </p>
  <p class="fragment">
    <b>Answer:</b> $p_{\text{coal}}=\frac{k(k-1)}{2}\frac{1}{N}=\binom{k}{2}\frac{1}{N}$
  </p>

</section>

<section>
  <h1>Kingman's coalescent</h1>

  <div style="display:inline-block;vertical-align:middle;width:60%" class="spaced">
    <ul>
      <li>Backward-time Markov process which produces 
        sampled time trees.</li>
      <li>Equivalent to sampled trees produced by WF
        model when $N\gg k$ and $g\ll 1$.</li>
      <li>Times between coalescence events drawn
        from exponential distributions with rate $\binom{k}{2}\frac{1}{Ng}$.</li>
      <li>Interesting: expected time to MRCA is always $\leq \frac{2}{Ng}$, regardless of how many samples there are.</li>
    </ul>
  </div>
  <div style="display:inline-block;vertical-align:middle;width:39%">
    <img data-src="simulated_coal_trees.svg">
  </div>
</section>

<section>
  <h1>Effective population size</h1>

  <ul>
    <li>If a real population were described precisely by a Wright-Fisher model with generation time $g$, the $N$ parameter in the coalescent would correspond to the real population size.</li>
    <li>However, real populations are more complicated:
      <ul>
        <li>Random mating assumption is often violated,</li>
        <li>Offspring distribution may differ from that assumed by WF,</li>
        <li>Generations may be overlapping,</li>
        <li>...</li>
      </ul>
      <li>We therefore define the <b>effective population size</b>
      $N_e$ to be the size of a statistically equivalent WF population.
      (We often also absorb other parameters such as $g$, the clock
      rate and ploidy into this number.)</li>
  </ul>
  
</section>

<section>
  <h1>Probability of a coalecent tree</h1>

  <center>
  <div class="flipper" style="width:70%;height:400px">
    <img data-src="coalProb1.svg">
    <img data-src="coalProb2.svg" class="fragment">
  </div>
  </center>

  <div class="fragment" style="margin-top:5%">
    \begin{equation}
    P(T|N_e)=\prod_{i=1}^{n-1}\left(\exp\left[-\Delta t_i\binom{k_i}{2}\frac{1}{N_e}\right]\frac{1}{N_e}\right)
    \end{equation}
  </div>
</section>

<section>
  <h1>Coalescent-based inference</h1>

  <ul>
    <li>We can therefore infer demographic parameters like $N_e$ given a known phylogeny!</li>
  </ul>

  $L(N_e|T)=P(T|N_e)$

  <div style="width:100%;margin-top:10%">
    <div id="coalDensity"
         style="width:400px;height:300px;display:inline-block;vertical-align:middle">
    <script>
      target = document.getElementById('coalDensity');

      var Ne = [];
      var p = [];
      var minNe=2.0;
      var maxNe=5.0;
      for (var thisNe=minNe; thisNe<=maxNe; thisNe += (maxNe-minNe)/200) {
          Ne.push(thisNe);
          p.push(-(12*0.5/thisNe + 3*1/thisNe + 1*1.3/thisNe) - 3*Math.log(thisNe));
      }

      var trace = {x: Ne, y: p, name: 'Ng=0.5', line: {width: 4}};

      Plotly.plot(target,
                  [trace],
                  { 
                      margin: { t: 0 },
                      xaxis: {title: "N"},
                      yaxis: {title: "log L(N|T)"},
                      font: {size: 20}
                  },
                  {displayModeBar: false});
    </script>
  </div>
  <div style="width:500px;display:inline-block;vertical-align:middle">
    <img data-src="coalProb2.svg">
  </div>
  </div>
</section>

<section>
  <h1>Robustness of the coalescent</h1>

  <ul>
    <li>The coalescent distribution/process is often derived as a limit of the Wright-Fisher process, as we have done here.</li>
    <li>It also appears as the limit of many other population processes, for example
    <ul>
      <li>The Canning model (generalization of the Wright-Fisher model)</li>
      <li>The Moran model (overlapping generations, fixed population size)</li>
      <li>some stochastic logistic models (continuous time, population fluctuations)</li>
      <li>...</li>
    </ul>
    <li>The fact that the coalescent distribution persists in the face
    of many departures from the WF model is sometimes termed the
    "robustness of the coalescent".</li>
  </ul>
</section>

<section>
  <h1>General assumptions of the coalescent</h1>

  <ol class="spaced" style="margin-top:10%">
    <li>Samples are members of a population that is at demographic equilibrium.</li>
    <li>Number of samples is small compared to the total population size.
      <ul>
        <li>Necessary for WF-based derivation, not all derivations.</li>
      </ul>
    <li>Population is "well mixed", samples are drawn randomly.</li>
  </ol>
  </ol>
</section>

<section class="center">
  <h1>Questions?</h1>
</section>

<section>
  <h1>Extensions to the coalescent</h1>

  <ul class="spaced" style="margin-top:10%">
    <li>Population changing through time.</li>
    <li>Population structured in some way.</li>
  </ul>
</section>

<section>
  <h1>Extension: population size changes</h1>

  <div>
    <img data-src="WFpopDyn.jpg">
    <a href="" class="cite">K&uuml;hnert et al., 2011</a>
</section>

<section>
  <h1>Estimating population growth</h1>

  <ul>
    <li>The coalescent can be extended to accommodate time-varying population sizes.</li>
  </ul>

  <div style="display:inline-block;vertical-align:top;height:275px">
    <img data-src="HCV_growth_title.png">
  </div>
  <div style="display:inline-block;vertical-align:top;height:275px">
    <img data-src="HCV_growth_figure.png">
  </div>

  <div style="display:inline-block;vertical-align:middle;width:80%">
    <img data-src="HCV_growth_table.png">
  </div>
  
</section>

<section>
  <h1>Modeling population size changes</h1>

  <ul class="spaced" style="margin-top:10%">
    <li>Parametric models assume population size changes according to
    some deterministic function of time (e.g. exponential
    growth).</li>
    <li>Non-parametric models allow population size to change over
    time in a relatively unconstrained manner.</li>
  </ul>
</section>

<section>
  <h1>Non-parametric: Skyline plot</h1>

  <center>
  <div class="flipper" style="width:80%;height:550px;text-align:center">
    <img data-src="skyline_schematic1.svg" style="width:100%">
    <img data-src="skyline_schematic2.svg" style="width:100%" class="fragment">
  </div>
  </center>
  <ul style="margin-top:-2em" class="fragment">
    <li>Due to <a href="" class="cite">Pybus, Rambaut and Harvey, 2000</a>.</li>
    <li>Directly yields ML estimates of population size in each interval.</li>
  </ul>
  
</section>

<section>
  <h1>Bayesian skyline</h1>

  <ul class="spaced" style="margin-top:5%">
    <li>Piecewise-constant population model: population size can only
    change at a fixed number of break points. Each time iterval can
    contain several coalescent intervals.</li>

    <li>Uses MCMC to integrate over all possible break point positions in addition to $N_e$ within each time interval.</li>

    <li>Graphs of marginal probability of population size vs time
    appear smoothed due to averaging over possible histories.</li>
  </ul>
</section>

<section>
  <h1>Example: $N_e$ for HCV in Egypt</h1>

  <center>
    <img data-src="hcv_bsp.gif" style="width:60%">

    <div style="text-align:right;width:60%">
      <a href="" class="cite">Drummond et al., 2005</a>
    </div>
  </center>
  
</section>

<section>
  <h1>Example: $N_e$ for influenza (H3N2)</h1>

  <center>
    <img data-src="flu_bsp.jpg" style="width:80%">

    <div style="text-align:right;width:80%" >
      <a href="" class="cite">Rambaut et al., 2008</a>
    </div>
  </center>
  
</section>

<section>
  <h1>Extension: population structure</h1>
</section>

<section>
  <h1>Coalescent summary</h1>
</section>

<section class="center">
  <h1>Questions?</h1>
</section>

<section class="center">
  <h1>Birth-death models in phylodynamics</h1>
</section>

<!--
* What is phylodynamics?
* Example application
* Need for phylodynamic models
* Phylodynamic models: birth-death and coalescent

- Question break -

* Coalescent theory (WF)
* Effective population size
* Coal tree prior and inference

- Question break -

* Population dynamics (parametric, non-parametric)
* Population structure (structured coalescent)
* Coalescent summary

- Question break -

* Birth-death models of population dynamics (reaction formalism)
* Retrospective view

  -->
